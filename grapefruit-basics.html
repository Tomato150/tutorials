
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>PeepsQuest Dev</title>
    <!-- Stylesheets -->
    <link rel='stylesheet' type='text/css' href='css/style.css' />

    <!-- Scripts -->
    <!--[if lt IE 9]><script type="text/javascript" src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>
<body>

  <div id="page-wrapper">

    <div class="row">

      <!-- Sidebar -->
      <section id="sidebar" class="col sidebar">
        <h2><a href="index.html#">PeepsQuest Dev</a></h2>
        <ul>
          <li><a href="https://github.com/peepsquest/tutorials">Github</a></li>
        </ul>
        
        <h2 id='h-tutorialsindexhtml'><a href="index.html">Tutorials</a></h2>
<h3 id='h-general'>General</h3>
<ul>
<li><a href="creating-sprite-sheets.html">Creating Sprite Sheets</a></li>
</ul>
<h3 id='h-pixijs'>Pixi.js</h3>
<ul>
<li><a href="pixi-basics.html">Basics</a></li>
<li><a href="isometric-map-basics.html">Isometric - Map Basics</a></li>
<li><a href="isometric-tiles-with-height.html">Isometric - Tiles w/ Height</a></li>
<li><a href="isometric-placing-avatar.html">Isometric - Avatar</a></li>
</ul>
<h3 id='h-grapefruitjs'>Grapefruitjs</h3>
<ul>
<li><a href="grapefruit-uml.html">UML Diagrams</a></li>
<li><a href="grapefruit-basics.html">Basics</a></li>
</ul>

      </section>

      <!-- Main Body -->
      <article id="content" class="col content">
        <a href='index.html'>
          <img id="logo" src="img/peepsquest.png" />
        </a>
        <h1 id='h-grapefruitjs-basics'>Grapefruitjs Basics</h1>
<div class='section-example'><p>In this I&#39;ll cover the basics of using the <a href="https://github.com/grapefruitjs/grapefruit">Grapefruitjs</a>
game engine built on <strong>pixi.js</strong>.</p>
<div class='note'><em>Grapefruitjs</em> is in its infancy and should not be used yet per its author,
<a href="https://github.com/englercj">Chad Engler</a>. The API is in flux. The author is an active contributor to <strong>pixi.js</strong>.
This is more an excercise to learn the design patterns an experienced game developer uses in creating
a game.
</div>

<p>Pan by dragging the map with the mouse or move the orsb/leaves around by first clicking on one then using arrow
keys. None of the objects are constrained to the world yet (still learning <strong>grapefruitjs</strong>).</p>
<div id="grapefruit-basics0_tabs" class="tabs">
  <ul>
    <li class="active">
  <a href="#grapefruit-basics0result-tab" rel="grapefruit-basics0result-tab">
    result
  </a>
</li><li>
  <a href="#grapefruit-basics0markuphtml-tab" rel="grapefruit-basics0markuphtml-tab">
    markup.html
  </a>
</li><li>
  <a href="#grapefruit-basics0stylecss-tab" rel="grapefruit-basics0stylecss-tab">
    style.css
  </a>
</li><li>
  <a href="#grapefruit-basics0scriptjs-tab" rel="grapefruit-basics0scriptjs-tab">
    script.js
  </a>
</li>
  </ul>
</div>
<div id="grapefruit-basics0_tabs_content" class="tabs_content">
  <div id="grapefruit-basics0result-tab" class="tab_content">
  <iframe id="grapefruit-basics0" src="examples/grapefruit-basics0.html" class="result"  style='height: 600px;'></iframe>
</div><div id="grapefruit-basics0markuphtml-tab" class="tab_content">
  <pre><code class="language-html"><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;<span class="title">html</span>&gt;</span>
  <span class="tag">&lt;<span class="title">head</span>&gt;</span>
    <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">'stylesheet'</span> <span class="attribute">type</span>=<span class="value">'text/css'</span> <span class="attribute">href</span>=<span class="value">'../css/reset.css'</span> /&gt;</span>
    <span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">'stylesheet'</span> <span class="attribute">type</span>=<span class="value">'text/css'</span> <span class="attribute">href</span>=<span class="value">'grapefruit-basics0-style.css'</span> /&gt;</span>
  <span class="tag">&lt;/<span class="title">head</span>&gt;</span>
  <span class="tag">&lt;<span class="title">body</span>&gt;</span>
    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">'game'</span>&gt;</span><span class="comment">&lt;!-- game goes here --&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span>

<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"http://code.jquery.com/jquery-1.10.2.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"</span>&gt;</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"js/vendor/gf.js"</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>

<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">'grapefruit-basics.js'</span>&gt;</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
    
  <span class="tag">&lt;/<span class="title">body</span>&gt;</span>
<span class="tag">&lt;/<span class="title">html</span>&gt;</span>
</code></pre>
</div><div id="grapefruit-basics0stylecss-tab" class="tab_content">
  <pre><code class="language-css"><span class="id">#game</span> <span class="rules">{
  <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">590</span>px</span></span>;
<span class="rule">}</span></span>
<span class="tag">body</span> <span class="rules">{
  <span class="rule"><span class="attribute">margin</span>:<span class="value"> <span class="number">0</span></span></span>;
  <span class="rule"><span class="attribute">padding</span>:<span class="value"> <span class="number">0</span></span></span>;
<span class="rule">}</span></span></code></pre>
</div><div id="grapefruit-basics0scriptjs-tab" class="tab_content">
  <pre><code class="language-js"><span class="comment">/* globals $,_,window,gf */</span>
<span class="string">"use strict"</span>;

<span class="keyword">var</span> assets = [{
  name: <span class="string">'world'</span>,
  src: <span class="string">'img/isometric_grass_and_water.json'</span>
}, {
  name: <span class="string">'avatar'</span>,
  src: <span class="string">'img/redOrb.png'</span>
}];


<span class="keyword">var</span> Game = <span class="function"><span class="keyword">function</span><span class="params">(containerId, options)</span> {</span>
  <span class="keyword">this</span>.options = options;
  _.defaults(<span class="keyword">this</span>.options, {
    gravity: <span class="number">0</span>,
    friction: <span class="number">0</span>
  });
  gf.Game.call(<span class="keyword">this</span>, containerId, <span class="keyword">this</span>.options);
};

gf.inherits(Game, gf.Game, {
  start: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> that = <span class="keyword">this</span>;
    <span class="keyword">this</span>.loader.on(<span class="string">'complete'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
      that.onGameReady();
      that.render();
    });
    <span class="keyword">this</span>.loader.load(<span class="keyword">this</span>.options.assets);
  },

  onGameReady: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> state = <span class="keyword">new</span> gf.GameState(<span class="string">'world'</span>);
    <span class="keyword">this</span>.addState(state);

    state.loadWorld(<span class="string">'world'</span>);
    state.world.interactive = <span class="literal">true</span>;
    state.world.mousedown = mapDown;
    state.world.mouseup = mapUp;
    state.world.mousemove = mapMove;
    state.world.on(<span class="string">'object.mousedown'</span>, objDown);
    state.input.keyboard.on(gf.input.KEY.DOWN, onKeyboardDown);
    state.input.keyboard.on(gf.input.KEY.UP, onKeyboardUp);
    state.input.keyboard.on(gf.input.KEY.LEFT, onKeyboardLeft);
    state.input.keyboard.on(gf.input.KEY.RIGHT, onKeyboardRight);

    <span class="keyword">this</span>.enableState(<span class="string">'world'</span>);
    <span class="keyword">var</span> layer = <span class="keyword">this</span>.world.findLayer(<span class="string">'beings'</span>);
    layer.spawn();

    <span class="comment">// start with the world centered and slightly down</span>
    <span class="keyword">this</span>.world.pan(<span class="keyword">this</span>.camera.size.x / <span class="number">2</span>, <span class="number">100</span>);
  }
});


<span class="function"><span class="keyword">function</span> <span class="title">mapDown</span><span class="params">(e)</span> {</span>
  <span class="keyword">var</span> pos = e.getLocalPosition(<span class="keyword">this</span>.parent);
  <span class="keyword">this</span>.drag = pos;
}

<span class="function"><span class="keyword">function</span> <span class="title">mapUp</span><span class="params">(e)</span> {</span>
  <span class="keyword">this</span>.drag = <span class="literal">null</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">mapMove</span><span class="params">(e)</span> {</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.drag) {
    <span class="keyword">var</span> pos = e.getLocalPosition(<span class="keyword">this</span>.parent);
    <span class="keyword">var</span> dx = pos.x - <span class="keyword">this</span>.drag.x;
    <span class="keyword">var</span> dy = pos.y - <span class="keyword">this</span>.drag.y;

    <span class="keyword">this</span>.pan(dx, dy);
    <span class="keyword">this</span>.drag = pos;
  }
}


<span class="keyword">var</span> activeObject = <span class="literal">null</span>;
<span class="keyword">var</span> DISTANCE = <span class="number">4</span>;

<span class="function"><span class="keyword">function</span> <span class="title">preventDefault</span><span class="params">(e)</span> {</span>
  e.input.preventDefault(e.originalEvent);
}

<span class="function"><span class="keyword">function</span> <span class="title">moveActive</span><span class="params">(dx, dy, e)</span> {</span>
  <span class="keyword">if</span> (!activeObject &amp;&amp; !activeObject.location) <span class="keyword">return</span>;
  <span class="keyword">var</span> location = activeObject.location;
  activeObject.setPosition(location.x + dx, location.y + dy);
  preventDefault(e);
}

<span class="function"><span class="keyword">function</span> <span class="title">objDown</span><span class="params">(e)</span> {</span>
  <span class="keyword">if</span> (activeObject)
    activeObject.alpha = <span class="number">1</span>;
  activeObject = e.object;
  activeObject.alpha = <span class="number">0.5</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">onKeyboardDown</span><span class="params">(e)</span> {</span>
  e.originalEvent.shiftKey ? moveActive(<span class="number">0</span>, DISTANCE, e) :
    moveActive(DISTANCE, DISTANCE, e);
}

<span class="function"><span class="keyword">function</span> <span class="title">onKeyboardRight</span><span class="params">(e)</span> {</span>
  e.originalEvent.shiftKey ? moveActive(DISTANCE, <span class="number">0</span>, e) :
    moveActive(DISTANCE, -DISTANCE, e);
}

<span class="function"><span class="keyword">function</span> <span class="title">onKeyboardLeft</span><span class="params">(e)</span> {</span>
  e.originalEvent.shiftKey ? moveActive(-DISTANCE, <span class="number">0</span>, e) :
    moveActive(-DISTANCE, DISTANCE, e);
}

<span class="function"><span class="keyword">function</span> <span class="title">onKeyboardUp</span><span class="params">(e)</span> {</span>
  e.originalEvent.shiftKey ? moveActive(<span class="number">0</span>, -DISTANCE, e) :
    moveActive(-DISTANCE, -DISTANCE, e);
}


$(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
  <span class="keyword">var</span> $game = $(<span class="string">'#game'</span>);
  <span class="keyword">var</span> game = <span class="keyword">new</span> Game(<span class="string">'game'</span>, {
    width: $game.width() - <span class="number">3</span>,
    height: $game.height() - <span class="number">3</span>,
    background: <span class="number">0xEEFFFF</span>,
    assets: assets
  });
  window.dbgGame = game;
  game.start();
});</code></pre>
</div>
</div><h2 id='h-loading-assets'>Loading Assets</h2>
<p><code>gf.AssetLoader</code> loads assets given an array of URLs or objects.
I opt for objects to show <code>gf.assetCache</code> which is used later when loading the orb. <strong>Grapefruitjs</strong> supports
the popular <a href="http://www.mapeditor.org/">Tiled Map Editor</a> TMX (JSON) format as well as Texture Packer
format supported by <strong>pixi.js</strong>.</p>
<pre><code class="js"><span class="keyword">var</span> assets = [
    {name: <span class="string">'world'</span>, src: <span class="string">'img/isometric_grass_and_water.json'</span>},
    {name: <span class="string">'avatar'</span>, src: <span class="string">'img/redOrb.png'</span>}
];</code></pre>
<h2 id='h-configure-the-game'>Configure the Game</h2>
<p>The main thing to do is to configure an instance of <code>gf.Game</code> and attach it to
an HTMLElement container of fixed width and size. Hidden within <code>Game</code> is the <code>_tick</code> game loop
which makes everything run.</p>
<pre><code class="js"><span class="keyword">var</span> Game = <span class="function"><span class="keyword">function</span><span class="params">(containerId, options)</span> {</span>
    <span class="keyword">this</span>.options = options;
    _.defaults(<span class="keyword">this</span>.options, {
        gravity: <span class="number">0</span>,
        friction: <span class="number">0</span>
    });
    gf.Game.call(<span class="keyword">this</span>, containerId, <span class="keyword">this</span>.options);
};</code></pre>
<p>The <code>start</code> method loads the <code>assets</code> and when completed <code>onGameReady</code> is invoked.</p>
<pre><code class="js">gf.inherits(Game, gf.Game, {
    start: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> that = <span class="keyword">this</span>;
        <span class="keyword">this</span>.loader.on(<span class="string">'complete'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            that.onGameReady();
            that.render();
        });
        <span class="keyword">this</span>.loader.load(<span class="keyword">this</span>.options.assets);
    },</code></pre>
<h2 id='h-loading-a-world'>Loading a World</h2>
<p>AFAICT a world is just a display container. The important data structure is the <code>GameState</code> and
more importantly the active game state.</p>
<pre><code class="js">    onGameReady: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> state = <span class="keyword">new</span> gf.GameState(<span class="string">'world'</span>);
        <span class="keyword">this</span>.addState(state);

        state.loadWorld(<span class="string">'world'</span>);
        state.world.interactive = <span class="literal">true</span>;
        state.world.mousedown = mapDown;
        state.world.mouseup = mapUp;
        state.world.mousemove = mapMove;
        state.world.on(<span class="string">'object.mousedown'</span>, objDown);
        state.input.keyboard.on(gf.input.KEY.DOWN, onKeyboardDown);
        state.input.keyboard.on(gf.input.KEY.UP, onKeyboardUp);
        state.input.keyboard.on(gf.input.KEY.LEFT, onKeyboardLeft);
        state.input.keyboard.on(gf.input.KEY.RIGHT, onKeyboardRight);

        <span class="keyword">this</span>.enableState(<span class="string">'world'</span>);
        <span class="keyword">var</span> layer = <span class="keyword">this</span>.world.findLayer(<span class="string">'beings'</span>);
        layer.spawn();

        <span class="comment">// start with the world centered and slightly down</span>
        <span class="keyword">this</span>.world.pan(<span class="keyword">this</span>.camera.size.x / <span class="number">2</span>, <span class="number">100</span>);
    }
});</code></pre>
<h2 id='h-interacting-with-the-world'>Interacting with the World</h2>
<p>Interacting with objects is through events, although it&#39;s a little bit
inconsistent. Mouse events are by assigning functions and keyboard and
object events are through pub-sub.</p>
<p>On mouse drag we&#39;ll pan the world.</p>
<pre><code class="js"><span class="function"><span class="keyword">function</span> <span class="title">mapDown</span><span class="params">(e)</span> {</span>
    <span class="keyword">var</span> pos = e.getLocalPosition(<span class="keyword">this</span>.parent);
    <span class="keyword">this</span>.drag = pos;
}

<span class="function"><span class="keyword">function</span> <span class="title">mapUp</span><span class="params">(e)</span> {</span>
    <span class="keyword">this</span>.drag = <span class="literal">null</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">mapMove</span><span class="params">(e)</span> {</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.drag) {
        <span class="keyword">var</span> pos = e.getLocalPosition(<span class="keyword">this</span>.parent);
        <span class="keyword">var</span> dx = pos.x - <span class="keyword">this</span>.drag.x;
        <span class="keyword">var</span> dy = pos.y - <span class="keyword">this</span>.drag.y;

        <span class="keyword">this</span>.pan(dx, dy);
        <span class="keyword">this</span>.drag = pos;
    }
}</code></pre>
<p>On mouse click make an object active.</p>
<pre><code class="js"><span class="keyword">var</span> activeObject = <span class="literal">null</span>;
<span class="keyword">var</span> DISTANCE = <span class="number">4</span>;

<span class="function"><span class="keyword">function</span> <span class="title">preventDefault</span><span class="params">(e)</span> {</span>
    e.input.preventDefault(e.originalEvent);
}

<span class="function"><span class="keyword">function</span> <span class="title">moveActive</span><span class="params">(dx, dy, e)</span> {</span>
    <span class="keyword">if</span> (!activeObject &amp;&amp; !activeObject.location) <span class="keyword">return</span>;
    <span class="keyword">var</span> location = activeObject.location;
    activeObject.setPosition(location.x + dx, location.y + dy);
    preventDefault(e);
}

<span class="function"><span class="keyword">function</span> <span class="title">objDown</span><span class="params">(e)</span> {</span>
    <span class="keyword">if</span> (activeObject)
        activeObject.alpha = <span class="number">1</span>;
    activeObject = e.object;
    activeObject.alpha = <span class="number">0.5</span>;
}</code></pre>
<p>On keyboard move the active object.</p>
<pre><code class="js"><span class="function"><span class="keyword">function</span> <span class="title">onKeyboardDown</span><span class="params">(e)</span> {</span>
    e.originalEvent.shiftKey ? moveActive(<span class="number">0</span>, DISTANCE, e) :
            moveActive(DISTANCE, DISTANCE, e);
}

<span class="function"><span class="keyword">function</span> <span class="title">onKeyboardRight</span><span class="params">(e)</span> {</span>
    e.originalEvent.shiftKey ? moveActive(DISTANCE, <span class="number">0</span>, e) :
            moveActive(DISTANCE, -DISTANCE, e);
}

<span class="function"><span class="keyword">function</span> <span class="title">onKeyboardLeft</span><span class="params">(e)</span> {</span>
    e.originalEvent.shiftKey ? moveActive(-DISTANCE, <span class="number">0</span>, e) :
            moveActive(-DISTANCE, DISTANCE, e);
}

<span class="function"><span class="keyword">function</span> <span class="title">onKeyboardUp</span><span class="params">(e)</span> {</span>
    e.originalEvent.shiftKey ? moveActive(<span class="number">0</span>, -DISTANCE, e) :
            moveActive(-DISTANCE, -DISTANCE, e);
}</code></pre>
<h2 id='h-start-the-game'>Start the Game</h2>
<p>The game needs a <code>div</code> to attach to.</p>
<pre><code class="html"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">'game'</span>&gt;</span><span class="comment">&lt;!-- game goes here --&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></code></pre>
<p>Calculate the width of the div, which is set by CSS, and pass the <code>div</code> info to the game and start it.</p>
<pre><code class="css"><span class="id">#game</span> <span class="rules">{
  <span class="rule"><span class="attribute">height</span>:<span class="value"> <span class="number">590</span>px</span></span>;
<span class="rule">}</span></span></code></pre>
<pre><code class="js">$(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> $game = $(<span class="string">'#game'</span>);
    <span class="keyword">var</span> game = <span class="keyword">new</span> Game(<span class="string">'game'</span>, {
        width: $game.width() - <span class="number">3</span>,
        height: $game.height() - <span class="number">3</span>,
        background: <span class="number">0xEEFFFF</span>,
        assets: assets
    });
    window.dbgGame = game;
    game.start();
});</code></pre>
</div>
      </article>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
  <script src="examples/tutdown.js"></script>
  <script>
  $(function() {
    $('.more-details').click(function() {
      $this = $(this);
      if ($this.hasClass('collapsed')) {
        $this.removeClass('collapsed');
        $this.addClass('uncollapsed');
      } else {
        $this.removeClass('uncollapsed');
        $this.addClass('collapsed');
      }
    });
  });
  </script>
  <!--
  <script type="text/javascript">
    (function() {
      var b = document.createElement("script"); b.type = "text/javascript"; b.async = true;
      b.src = "https://barc.com/js/libs/barc/barc.js";
      var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(b, s);
    })();
  </script>
  -->
  <script type="text/javascript">
    $('#sidebar a').each(function() {
      var
        $a = $(this),
        href = window.location.href;
      if (href.indexOf && href.indexOf($a.attr('href')) > -1 && href.indexOf('#') === -1) // hacky to grab only example links
        $a.closest('li').addClass('active');
    });
  </script>
</body>
</html>

